define(["jquery"],function(e){var a=function(a){return a&&e.inArray(a,["es_US","en_CA","fr_CA","en_GB","en_AU"])<0&&(a="en_US"),a},t=function(e){return e&&(e=a(e),r.sessionVars.set("locale",e)),e},n=function(e,a){return(e?r.global.path.secure+"S":r.global.path.nonsecure)+"PageServer"+(r.global.routingId&&""!==r.global.routingId?";"+r.global.routingId:"")+"?pagename=luminateExtend_server&pgwrap=n"+(a?"&"+a:"")},o=function(a,t){if(a.responseFilter&&a.responseFilter.array&&a.responseFilter.filter&&r.utils.stringToObj(a.responseFilter.array,t)){var n,o,s=a.responseFilter.filter.split("==")[0].split("!=")[0].replace(/^\s+|\s+$/g,"");if(-1!==a.responseFilter.filter.indexOf("!=")?(n="nequal",o=a.responseFilter.filter.split("!=")[1]):-1!==a.responseFilter.filter.indexOf("==")&&(n="equal",o=a.responseFilter.filter.split("==")[1]),n&&o){o=o.replace(/^\s+|\s+$/g,"");var i=[],l=!1;if(e.each(r.utils.ensureArray(r.utils.stringToObj(a.responseFilter.array,t)),function(){"nequal"===n&&this[s]===o||"equal"===n&&this[s]!==o?l=!0:i.push(this)}),l){var u=a.responseFilter.array.split(".");e.each(t,function(a,n){a===u[0]&&e.each(n,function(n,o){n===u[1]&&(2===u.length?t[a][n]=i:e.each(o,function(o,r){o===u[2]&&(3===u.length?t[a][n][o]=i:e.each(r,function(e,r){e===u[3]&&4===u.length&&(t[a][n][o][e]=i)}))}))})})}}}var c=e.noop;a.callback&&("function"==typeof a.callback?c=a.callback:a.callback.error&&t.errorResponse?c=a.callback.error:a.callback.success&&!t.errorResponse&&(c=a.callback.success));var p=-1!==a.data.indexOf("&method=login")&&-1===a.data.indexOf("&method=loginTest"),d=-1!==a.data.indexOf("&method=logout");if(p||d){var g={callback:function(){c(t)},useCache:!1,useHTTPS:a.useHTTPS};p&&t.loginResponse&&t.loginResponse.nonce&&(g.nonce="NONCE_TOKEN="+t.loginResponse.nonce),r.api.getAuth(g)}else c(t)},r=function(e){r.init(e||{})};r.library={version:"1.7.1"},r.global={update:function(a,n){a&&(a.length?n&&("locale"===a&&(n=t(n)),r.global[a]=n):(a.locale&&(a.locale=t(a.locale)),r.global=e.extend(r.global,a)))}},r.init=function(t){var n=e.extend({apiCommon:{},auth:{type:"auth"},path:{}},t||{});(n.locale&&(n.locale=a(n.locale)),n.supportsCORS=!1,window.XMLHttpRequest)&&("withCredentials"in new XMLHttpRequest&&(n.supportsCORS=!0));return r.global=e.extend(r.global,n),r},r.api=function(e){r.api.request(e||{})},r.api.bind=function(a){return e(a=a||"form.luminateApi").length>0&&e(a).each(function(){"form"===this.nodeName.toLowerCase()&&e(this).bind("submit",function(a){a.cancelBubble=!0,a.returnValue=!1,a.stopPropagation&&(a.stopPropagation(),a.preventDefault()),e(this).attr("id")||e(this).attr("id","luminateApi-"+(new Date).getTime());var t,n=e(this).attr("action"),o=n.split("?"),s=e(this).data("luminateapi"),i=-1!==o[0].indexOf("/site/")?o[0].split("/site/")[1]:o[0],l=e(this).attr("enctype"),u=o.length>1?o[1]:"",c="#"+e(this).attr("id"),p=!1,d=!1;s&&(s.callback&&(t=r.utils.stringToObj(s.callback)),s.requiresAuth&&"true"===s.requiresAuth&&(p=!0),(0===n.indexOf("https:")||"https:"===window.location.protocol&&-1===n.indexOf("http"))&&(d=!0)),r.api.request({api:i,callback:t,contentType:l,data:u,form:c,requiresAuth:p,useHTTPS:d})})}),r},r.api.getAuth=function(a){var t=e.extend({useCache:!0,useHTTPS:!1},a||{});if(r.api.getAuthLoad)if(r.api.getAuthLoad=!1,t.useCache&&r.global.auth.type&&r.global.auth.token)r.api.getAuthLoad=!0,t.callback&&t.callback();else{var o=function(e){r.global.update(e),r.api.getAuthLoad=!0,t.callback&&t.callback()};r.global.supportsCORS?e.ajax({url:(t.useHTTPS?r.global.path.secure:r.global.path.nonsecure)+"CRConsAPI",data:"luminateExtend="+r.library.version+(t.nonce&&""!==t.nonce?"&"+t.nonce:"")+"&api_key="+r.global.apiKey+"&method=getLoginUrl&response_format=json&v=1.0",xhrFields:{withCredentials:!0},dataType:"json",success:function(e){var a=e.getLoginUrlResponse,t=a.url,n=a.routing_id,r=a.JSESSIONID;n||-1===t.indexOf("CRConsAPI;jsessionid=")||(n=t.split("CRConsAPI;jsessionid=")[1].split("?")[0]),o({auth:{type:"auth",token:a.token},routingId:n?"jsessionid="+n:"",sessionCookie:r?"JSESSIONID="+r:""})}}):e.ajax({url:n(t.useHTTPS,"action=getAuth&callback=?"),dataType:"jsonp",success:o})}else setTimeout(function(){r.api.getAuth(t)},1e3)},r.api.getAuthLoad=!0;var s=function(a){var t=e.extend({contentType:"application/x-www-form-urlencoded",data:"",requiresAuth:!1,useHTTPS:null},a||{});if(e.inArray(t.api.toLowerCase(),["addressbook","advocacy","connect","cons","content","datasync","donation","email","group","orgevent","recurring","survey","teamraiser"])>=0&&(t.api="CR"+t.api.charAt(0).toUpperCase()+t.api.slice(1).toLowerCase()+"API",t.api=t.api.replace("Addressbook","AddressBook").replace("Datasync","DataSync").replace("Orgevent","OrgEvent")),r.global.path.nonsecure&&r.global.path.secure&&r.global.apiKey&&t.api){"multipart/form-data"===t.contentType.split(";")[0]?t.contentType="multipart/form-data":t.contentType="application/x-www-form-urlencoded",t.contentType+="; charset=UTF-8",t.data="luminateExtend="+r.library.version+(""===t.data?"":"&"+t.data),t.form&&e(t.form).length>0&&(t.data+="&"+e(t.form).eq(0).serialize()),-1===t.data.indexOf("&api_key=")&&(t.data+="&api_key="+r.global.apiKey),r.global.apiCommon.centerId&&-1===t.data.indexOf("&center_id=")&&(t.data+="&center_id="+r.global.apiCommon.centerId),r.global.apiCommon.categoryId&&-1===t.data.indexOf("&list_category_id=")&&(t.data+="&list_category_id="+r.global.apiCommon.categoryId),-1!==t.data.indexOf("&response_format=xml")?t.data=t.data.replace(/&response_format=xml/g,"&response_format=json"):-1===t.data.indexOf("&response_format=")&&(t.data+="&response_format=json"),r.global.apiCommon.source&&-1===t.data.indexOf("&source=")&&(t.data+="&source="+r.global.apiCommon.source),r.global.apiCommon.subSource&&-1===t.data.indexOf("&sub_source=")&&(t.data+="&sub_source="+r.global.apiCommon.subSource),-1===t.data.indexOf("&suppress_response_codes=")&&(t.data+="&suppress_response_codes=true"),r.global.locale&&-1===t.data.indexOf("&s_locale=")&&(t.data+="&s_locale="+r.global.locale),-1===t.data.indexOf("&v=")&&(t.data+="&v=1.0");var s="http://",i=r.global.path.nonsecure.split("http://")[1];"CRDonationAPI"===t.api||"CRTeamraiserAPI"===t.api||"CRConnectAPI"!==t.api&&("https:"===window.location.protocol&&null==t.useHTTPS||1==t.useHTTPS)?t.useHTTPS=!0:t.useHTTPS=!1,t.useHTTPS&&(s="https://",i=r.global.path.secure.split("https://")[1]),s+=i+t.api;var l,u=!1,c=!1,p=!1;window.location.protocol===s.split("//")[0]&&document.domain===i.split("/")[0]?(u=!0,c=!0):r.global.supportsCORS?c=!0:"postMessage"in window&&(p=!0),c?l=function(){r.global.routingId&&""!==r.global.routingId&&(s+=";"+r.global.routingId),t.requiresAuth&&-1===t.data.indexOf("&"+r.global.auth.type+"=")&&(t.data+="&"+r.global.auth.type+"="+r.global.auth.token),r.global.sessionCookie&&""!==r.global.sessionCookie&&(t.data+="&"+r.global.sessionCookie),t.data+="&ts="+(new Date).getTime(),e.ajax({url:s,data:t.data,xhrFields:{withCredentials:!0},contentType:t.contentType,dataType:"json",type:"POST",success:function(e){o(t,e)}})}:p&&(l=function(){var a=(new Date).getTime(),i="luminateApiPostMessage"+a,l=n(t.useHTTPS,"action=postMessage");r.global.routingId&&""!==r.global.routingId&&(s+=";"+r.global.routingId),t.requiresAuth&&-1===t.data.indexOf("&"+r.global.auth.type+"=")&&(t.data+="&"+r.global.auth.type+"="+r.global.auth.token),r.global.sessionCookie&&""!==r.global.sessionCookie&&(t.data+="&"+r.global.sessionCookie),t.data+="&ts="+a,r.api.request.postMessageEventHandler||(r.api.request.postMessageEventHandler={},r.api.request.postMessageEventHandler.handler=function(a){if(-1!==r.global.path.nonsecure.indexOf(a.origin)||-1!==r.global.path.secure.indexOf(a.origin)){var t=e.parseJSON(a.data),n=t.postMessageFrameId,o=e.parseJSON(decodeURIComponent(t.response));r.api.request.postMessageEventHandler[n]&&r.api.request.postMessageEventHandler[n](n,o)}},void 0!==window.addEventListener?window.addEventListener("message",r.api.request.postMessageEventHandler.handler,!1):void 0!==window.attachEvent&&window.attachEvent("onmessage",r.api.request.postMessageEventHandler.handler)),r.api.request.postMessageEventHandler[i]=function(a,n){o(t,n),e("#"+a).remove(),delete r.api.request.postMessageEventHandler[a]},e("body").append('<iframe style="position: absolute; top: 0; left: -999em;" name="'+i+'" id="'+i+'"></iframe>'),e("#"+i).bind("load",function(){var a='{"postMessageFrameId": "'+e(this).attr("id")+'", "requestUrl": "'+s+'", "requestContentType": "'+t.contentType+'", "requestData": "'+t.data+'"}',n=s.split("/site/")[0].split("/admin/")[0];document.getElementById(e(this).attr("id")).contentWindow.postMessage(a,n)}),e("#"+i).attr("src",l)}),t.requiresAuth||!c&&!u&&!r.global.sessionCookie?r.api.getAuth({callback:l,useHTTPS:t.useHTTPS}):l()}};return r.api.request=function(a){if(e.isArray(a)){a.reverse();var t=[];e.each(a,function(n){var o=e.extend({async:!0},this);if(o.async||n===a.length-1)t.push(o);else if((i=a[n+1]).callback&&"function"!=typeof i.callback){var r=i.callback.success||e.noop;i.callback.success=function(e){r(e),s(o)}}else{var i,l=(i=a[n+1]).callback||e.noop;i.callback={success:function(e){l(e),s(o)},error:function(e){l(e)}}}}),t.reverse(),e.each(t,function(){s(this)})}else s(a)},r.sessionVars={set:function(e,a,t){var n={};t&&(n.callback=t),e&&(n.data="s_"+e+"="+(a||""),r.utils.ping(n))}},r.tags=function(e,a){r.tags.parse(e,a)},r.tags.parse=function(a,t){r.widgets?r.widgets(a,t):(a=a&&"all"!==a?r.utils.ensureArray(a):["cons"],t=t||"body",e.each(a,function(a,n){if("cons"===n){var o=e(t).find(document.getElementsByTagName("luminate:cons"));if(o.length>0){r.api.request({api:"cons",callback:function(a){o.each(function(){a.getConsResponse?e(this).replaceWith(r.utils.stringToObj(e(this).attr("field"),a.getConsResponse)):e(this).remove()})},data:"method=getUser",requiresAuth:!0})}}}))},r.utils={ensureArray:function(a){return e.isArray(a)?a:a?[a]:[]},stringToObj:function(e,a){var t=a||window;if(e)for(var n=e.split("."),o=0;o<n.length;o++){if(o<n.length-1&&!t[n[o]])return{};t=t[n[o]]}return t},ping:function(a){var t=e.extend({data:null},a||{}),n="luminatePing"+(new Date).getTime();e("body").append('<img style="position: absolute; left: -999em; top: 0;" id="'+n+'" />'),e("#"+n).bind("load",function(){e(this).remove(),t.callback&&t.callback()}),e("#"+n).attr("src",("https:"===window.location.protocol?r.global.path.secure:r.global.path.nonsecure)+"EstablishSession"+(r.global.routingId&&""!==r.global.routingId?";"+r.global.routingId:"")+"?"+(null==t.data?"":t.data+"&")+"NEXTURL="+encodeURIComponent(("https:"===window.location.protocol?r.global.path.secure:r.global.path.nonsecure)+"PixelServer"))},simpleDateFormat:function(t,n,o){if(o=o||r.global.locale,o=a(o),n=n||(e.inArray(o,["en_CA","fr_CA","en_GB","en_AU"])>=0?"d/M/yy":"M/d/yy"),!((t=t||new Date)instanceof Date)){var s=t.split("T")[0].split("-"),i=t.split("T").length>1?t.split("T")[1].split(".")[0].split("Z")[0].split("-")[0].split(":"):["00","00","00"];t=new Date(s[0],s[1]-1,s[2],i[0],i[1],i[2])}var l=function(e){return 0===(e=""+e).indexOf("0")&&"0"!==e?e.substring(1):e},u=function(e){return e=Number(e),isNaN(e)?"00":(e<10?"0":"")+e},c={month:u(t.getMonth()+1),date:u(t.getDate()),year:u(t.getFullYear()),day:t.getDay(),hour24:t.getHours(),hour12:t.getHours(),minutes:u(t.getMinutes()),ampm:"AM"};c.hour24>11&&(c.ampm="PM"),c.hour24=u(c.hour24),0===c.hour12&&(c.hour12=12),c.hour12>12&&(c.hour12=c.hour12-12),c.hour12=u(c.hour12);var p=function(e){var a=e.replace(/yy+(?=y)/g,"yy").replace(/MMM+(?=M)/g,"MMM").replace(/d+(?=d)/g,"d").replace(/EEE+(?=E)/g,"EEE").replace(/a+(?=a)/g,"").replace(/k+(?=k)/g,"k").replace(/h+(?=h)/g,"h").replace(/m+(?=m)/g,"m").replace(/yyy/g,c.year).replace(/yy/g,c.year.substring(2)).replace(/y/g,c.year).replace(/dd/g,c.date).replace(/d/g,l(c.date)),t=function(e,a,t){for(var n=1;n<e.length;n++)if(!isNaN(e[n].substring(0,1))){var o=e[n].substring(0,2);e[n]=e[n].substring(2),isNaN(o.substring(1))&&(e[n]=o.substring(1)+e[n],o=o.substring(0,1)),(o=Number(o))>23&&(o=23);var r="+"===t?o:0-o;"kk"===a||"k"===a?(r=Number(c.hour24)+r)>24?r-=24:r<0&&(r+=24):((r=Number(c.hour12)+r)>24?r-=24:r<0&&(r+=24),r>12&&(r-=12)),r=""+r,"kk"!==a&&"hh"!==a||(r=u(r)),("h"===a&&0===r||"hh"===a&&"00"===r)&&(r="12"),e[n]=r+e[n]}return e.join("")};-1!==a.indexOf("k+")&&(a=t((a=t(a.split("kk+"),"kk","+")).split("k+"),"k","+")),-1!==a.indexOf("k-")&&(a=t((a=t(a.split("kk-"),"kk","-")).split("k-"),"k","-")),-1!==(a=a.replace(/kk/g,c.hour24).replace(/k/g,l(c.hour24))).indexOf("h+")&&(a=t((a=t(a.split("hh+"),"hh","+")).split("h+"),"h","+")),-1!==a.indexOf("h-")&&(a=t((a=t(a.split("hh-"),"hh","-")).split("h-"),"h","-")),a=(a=(a=a.replace(/hh/g,c.hour12<12&&c.hour12.indexOf&&0!==c.hour12.indexOf("0")?"0"+c.hour12:c.hour12).replace(/h/g,l(c.hour12))).replace(/mm/g,c.minutes).replace(/m/g,l(c.minutes))).replace(/a/g,"A");var n=["January","February","march","april","may","June","July","august","September","October","November","December"];"es_US"===o&&(n=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]),"fr_CA"===o&&(n=["janvier","f&#233;vrier","mars","avril","mai","juin","juillet","ao&#251;t","septembre","octobre","novembre","d&#233;cembre"]),a=a.replace(/MMMM/g,n[Number(c.month)-1]).replace(/MMM/g,n[Number(c.month)-1].substring(0,3)).replace(/MM/g,c.month).replace(/M/g,l(c.month)).replace(/march/g,"March").replace(/may/g,"May").replace(/Mayo/g,"mayo");var r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];return"es_US"===o&&(r=["domingo","lunes","martes","mi&eacute;rcoles","jueves","viernes","s&aacute;bado"]),"fr_CA"===o&&(r=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"]),a=(a=a.replace(/EEEE/g,r[c.day]).replace(/EEE/g,r[c.day].substring(0,3)).replace(/EE/g,r[c.day].substring(0,3)).replace(/E/g,r[c.day].substring(0,3))).replace(/A/g,c.ampm).replace(/april/g,"April").replace(/august/g,"August")};if(-1!==n.indexOf("'")){var d=n.replace(/\'+(?=\')/g,"''").split("''");if(1===d.length){d=n.split("'");for(var g=0;g<d.length;g++)g%2==0&&(d[g]=p(d[g]));return d.join("")}for(g=0;g<d.length;g++){for(var h=d[g].split("'"),b=0;b<h.length;b++)b%2==0&&(h[b]=p(h[b]));d[g]=h.join("")}return d.join("'")}return p(n)}},r});